<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>G-Safe Detox Helper v3 (Mobile)</title>

<!-- Optional PWA manifest (add the file later if you want) -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a0f1a">

<style>
:root{
  --bg:#0a0f1a; --card:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
  --line:#1f2937; --accent:#60a5fa; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --hourpx:28px; /* calendar hour row height (synced by JS) */
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:linear-gradient(180deg,#0b1220 0%, #0f172a 100%);
}

/* Layout helpers */
.wrap{max-width:1024px;margin:0 auto;padding:12px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.right{margin-left:auto}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
.muted{color:var(--muted)}
.badge{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1324}
.badge.good{background:#052e16;color:#86efac;border-color:#14532d}
.badge.warn{background:#3b2300;color:#fde68a;border-color:#713f12}
.badge.bad{background:#3b0a0a;color:#fecaca;border-color:#7f1d1d}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0c1426;color:#cbd5e1}
.codebox{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1324;border:1px solid #132036;border-radius:10px;padding:8px}

/* Buttons & inputs */
button,.btn{
  background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:10px;
  padding:10px 12px;font-size:14px;cursor:pointer
}
button:hover{border-color:#475569}
.btn.primary{background:linear-gradient(90deg,#60a5fa,#3b82f6);border-color:transparent;color:#0b1220}
.btn.ghost{background:transparent;border:1px dashed #334155}
.btn.warn{background:linear-gradient(90deg,#fbbf24,#f59e0b);border-color:transparent;color:#3b1f00}

input:not([type="checkbox"]):not([type="radio"]), select, textarea{
  width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0a1020; color:var(--text);
}
input:focus,select:focus,textarea:focus{outline:0; box-shadow:0 0 0 2px rgba(96,165,250,.35)}
label input[type="checkbox"], label input[type="radio"]{width:auto;margin-right:6px;vertical-align:middle}

button, .btn, .tabbtn { pointer-events:auto; touch-action:manipulation; }
  
/* Tabs */
.tablist{
  display:flex;gap:8px;border-bottom:1px solid var(--line);
  position:sticky;top:0;z-index:20;
  background:rgba(11,18,32,.9);backdrop-filter:blur(6px);padding:8px;
  -webkit-backdrop-filter: blur(6px); /* iOS */
  -webkit-tap-highlight-color: transparent; /* iOS touch polish */
}.tabbtn{appearance:none;border:1px solid var(--line);background:#0b1324;color:#cbd5e1;border-radius:999px;padding:8px 12px;cursor:pointer}
.tabbtn[aria-selected="true"]{background:linear-gradient(90deg,#60a5fa,#3b82f6);color:#0b1220;border-color:transparent}
.tabpanel{display:block}
.tabpanel[aria-hidden="true"]{display:none}

/* Calendar (time-grid) */
.cal{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.day{border:1px solid #172036;border-radius:12px;padding:8px;background:#0b1220}
.day h4{margin:0 0 6px;color:#cbd5e1}
.dayGrid{display:grid;grid-template-columns:60px 1fr;gap:8px}
.timecol{font-size:12px;color:#94a3b8}
.timecol .tick{height:var(--hourpx);line-height:var(--hourpx);border-top:1px dashed #1f2937}
.daybody{
  position:relative;border:1px solid #1f2937;border-radius:8px;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.03) 0 calc(var(--hourpx) - 1px),
    rgba(255,255,255,0.07) calc(var(--hourpx) - 1px) var(--hourpx)
  );
}
.segBlock{position:absolute;left:6px;right:6px;border-radius:6px;background:rgba(96,165,250,.15);border:1px solid #60a5fa;font-size:12px;padding:3px 6px}
.nowline{position:absolute;left:0;right:0;height:2px;background:#60a5fa}
.doseMark{position:absolute;left:0;right:0;height:2px;background:#22c55e;opacity:.95}
.doseMark.orange{background:#f59e0b}
.doseMark.red{background:#ef4444}

/* Bottom action dock */
.dock{position:sticky;bottom:0;z-index:4;background:rgba(10,16,32,.9);backdrop-filter:blur(6px);border-top:1px solid #1f2937;padding:10px 12px; border-radius:10px 10px 0 0}
.btn-timer{min-width:180px}
.btn-timer.red{background:#3b0a0a;border-color:#7f1d1d}
.btn-timer.orange{background:#3b2300;border-color:#713f12}
.btn-timer.green{background:#052e16;border-color:#14532d}

/* Mobile polish */
@media (max-width: 720px){
  .grid-2{grid-template-columns:1fr}
  .grid-3{grid-template-columns:1fr}
  .cal{grid-template-columns:1fr}
  .dock{padding-bottom:max(10px, env(safe-area-inset-bottom))}
  #doseBtn, #dosePickBtn{width:100%}
  input,select,textarea{font-size:16px}
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce){
  *{scroll-behavior:auto !important; transition:none !important; animation:none !important;}
}

/* === Print styles (A4 landscape, cover page + week-per-page) === */
@media print {
  @page { size: A4 landscape; margin: 10mm; }
  -webkit-print-color-adjust: exact; print-color-adjust: exact;
  :root{ --hourpx:24px; }

  /* Hide app UI, show only print containers */
  header, .tabs, #calendarWrap, #dosePicker, #servicesDrawer { display:none !important; }
  #printCover, #printCal { display:block !important; }

  #printCover{ page-break-after: always; }
  .weekPrint{ page-break-after: always; break-after: page; }

  body{ font: 12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; background:#fff; }
  .day h4{ font-size: 10px; }
  .segBlock{ font-size: 10px; padding: 3px 5px; }
}

/* Hidden by default; only visible during print or when exportPDF opens a new window */
/* Hidden on screen; never intercept taps */ #printCover, #printCal { display:none; position:static; pointer-events:none; }
</style>
</head>

<body>
<header class="wrap">
  <h1 style="margin:6px 0 4px">G-Safe Detox Helper <small class="muted" id="appVersion" style="font-size:12px">v3</small></h1>
  <div class="muted" style="font-size:12px">Offline-first. Your data stays in this browser (localStorage). Export JSON for backup.</div>
</header>

<!-- Tabs -->
<nav class="tablist tabs wrap" role="tablist" aria-label="Main sections">
  <button class="tabbtn" id="tab-start" role="tab" aria-selected="true" aria-controls="panel-start">Start</button>
  <button class="tabbtn" id="tab-recognise" role="tab" aria-selected="false" aria-controls="panel-recognise">Recognise</button>
  <button class="tabbtn" id="tab-stabilise" role="tab" aria-selected="false" aria-controls="panel-stabilise">Stabilise</button>
  <button class="tabbtn" id="tab-detox" role="tab" aria-selected="false" aria-controls="panel-detox">Detox</button>
  <button class="tabbtn" id="tab-symptoms" role="tab" aria-selected="false" aria-controls="panel-symptoms">Symptoms</button>
</nav>

<!-- Panels container -->
<main class="wrap">
  <!-- START panel -->
  <section id="panel-start" class="tabpanel" role="tabpanel" aria-labelledby="tab-start" aria-hidden="false">
    <div class="card">
      <h2 style="margin-top:0">Start here</h2>
      <p>This tab gives information about G/GBL and how to use this helper. Please read these tiles first before moving on.</p>
      <ul>
        <li>Info tiles about safety and planning</li>
        <li>Quick screen for dependence</li>
        <li>“What you need” checklist</li>
      </ul>
    </div>

    <div class="grid-3" style="margin-top:12px">
      <div class="card">
        <h3 style="margin:0 0 6px">What this is</h3>
        <p class="muted">An offline planning tool to recognise risk, stabilise on a minimum safe dose, and plan a taper.</p>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">Safety basics</h3>
        <div class="codebox">Avoid mixing with alcohol/benzos. Keep ≥1h between doses. If confusion, paranoia, fits, or collapse → <b>112/999</b>.</div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">What you need</h3>
        <ul class="muted" style="margin:6px 0 0 16px">
          <li>Accurate syringe/measurer</li>
          <li>Timer (this app has one)</li>
          <li>Supply estimate before starting</li>
        </ul>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Quick screen</h3>
      <div class="grid-3">
        <label><input type="checkbox" id="qc_often" data-autosave> Most days / hard to delay</label>
        <label><input type="checkbox" id="qc_night" data-autosave> Night dosing</label>
        <label><input type="checkbox" id="qc_withdrawal" data-autosave> Withdrawal if delaying</label>
        <label><input type="checkbox" id="qc_freq" data-autosave> ≥5/day or ≤3h apart</label>
        <label><input type="checkbox" id="qc_severe" data-autosave> Severe WD (confusion/paranoia/fits)</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" onclick="QC_eval()">Run quick screen</button>
        <span id="qc_status" class="muted"></span>
      </div>
      <div id="qc_result" class="codebox" aria-live="polite" style="margin-top:8px"></div>
    </div>
    <div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 6px">Data &amp; privacy</h3>
  <p class="muted">This app only stores data locally in this browser. You can erase it at any time.</p>
  <div class="row">
    <button class="btn warn" onclick="clearAllSavedData()">Clear all saved data on this device</button>
    <span id="clear_status" class="muted" aria-live="polite"></span>
  </div>
</div>
  </section>
  <!-- RECOGNISE panel -->
  <section id="panel-recognise" class="tabpanel" role="tabpanel" aria-labelledby="tab-recognise" aria-hidden="true">
    <div class="card">
      <h2 style="margin-top:0">Recognise patterns & risk</h2>
      <p class="muted">Use either quick triage or the detailed checklist to assess risk and decide whether to stabilise first.</p>
    </div>

    <!-- Quick triage -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Quick triage</h3>
      <div class="grid-3">
        <label><input type="checkbox" id="qt_daynight" data-autosave> Day &amp; night use</label>
        <label><input type="checkbox" id="qt_binge" data-autosave> Recent 2–5 day binge</label>
        <label><input type="checkbox" id="qt_weeks" data-autosave> Several weeks of use</label>
        <label><input type="checkbox" id="qt_gap" data-autosave> Can go ≥6h without</label>
        <label><input type="checkbox" id="qt_mix" data-autosave> Mixing with alcohol / benzos</label>
        <label><input type="checkbox" id="qt_severe" data-autosave> Confusion / paranoia / fits</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="QT_analyse()">Analyse risk</button>
        <span id="qt_status" class="muted"></span>
      </div>
      <div id="qt_result" class="codebox" aria-live="polite" style="margin-top:8px"></div>
    </div>

    <!-- Detailed checklist -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Detailed checklist</h3>
      <div class="grid-3">
        <label>Usual per-dose (ml)<br>
          <input type="number" id="q_usual_ml" step="0.1" min="0" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Shortest gap between doses (h)<br>
          <input type="number" id="q_gap_hours" step="0.5" min="0" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Longest daily span without (h)<br>
          <input type="number" id="q_span_hours" step="0.5" min="0" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Days of continuous use<br>
          <input type="number" id="q_days_cont" step="1" min="0" inputmode="numeric" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Night-only use?<br>
          <select id="q_night_only" data-autosave>
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
        <label>Severe withdrawal ever?<br>
          <select id="q_severe_wd" data-autosave>
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="SA_analyse()">Analyse risk</button>
        <span class="muted">This shows recommendations below. It won’t jump tabs.</span>
      </div>

      <div id="sa_result" class="card" style="margin-top:10px">
        <div id="sa_summary" class="codebox" aria-live="polite"></div>
        <div id="sa_actions" class="row" style="margin-top:8px">
          <!-- Buttons will appear here based on analysis -->
        </div>
        <div id="sa_next" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </section>

  <!-- STABILISE panel -->
  <section id="panel-stabilise" class="tabpanel" role="tabpanel" aria-labelledby="tab-stabilise" aria-hidden="true">
    <div class="card">
      <h2 style="margin-top:0">Stabilise on a minimum safe dose</h2>
      <p class="muted">Goal: pick a starting dose &amp; interval that keeps withdrawal minimal, using simple intervals (1h, 1.5h, 2h, etc.). Then actively tune using logs.</p>
    </div>

    <!-- Quick estimator (pre-stabilisation) -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Estimate starting point</h3>
      <div class="grid-3">
        <label>Recent per-dose (ml)<br>
          <input type="number" id="stab_recent_ml" step="0.1" min="0" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Shortest gap tolerated (h)<br>
          <input type="number" id="stab_short_gap" step="0.5" min="0.5" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
        <label>Longest gap recently (h)<br>
          <input type="number" id="stab_long_gap" step="0.5" min="0.5" inputmode="decimal" enterkeyhint="done" autocomplete="off" data-autosave>
        </label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="STAB_suggest()">Suggest dose &amp; interval</button>
        <span id="stab_suggest_note" class="muted"></span>
      </div>
      <div id="stab_suggest_out" class="codebox" aria-live="polite" style="margin-top:8px"></div>
    </div>

    <!-- Active stabilisation process -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Active stabilisation</h3>
      <div class="grid-3">
        <label>Stabilisation dose (ml)<br>
          <input type="number" id="stab_dose" step="0.1" min="0" inputmode="decimal" data-autosave>
        </label>
        <label>Dose every (h)<br>
          <select id="stab_interval" data-autosave>
            <option value="1">1</option>
            <option value="1.5">1.5</option>
            <option value="2" selected>2</option>
            <option value="3">3</option>
          </select>
        </label>
        <label>Baseline saved?<br>
          <select id="stab_baseline" data-autosave>
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
      </div>

      <!-- Logger row -->
      <div class="dock" style="margin-top:10px">
        <div class="row">
          <span class="muted" id="stab_clock">—</span>
          <span class="pill" id="stab_timerpill">Time since last dose: —</span>
          <span class="right"></span>
          <button id="stab_log_btn" class="btn btn-timer orange" onclick="STAB_logDose()">Log stabilisation dose</button>
          <button id="stab_other_btn" class="btn" onclick="openDosePicker('stabilise')">Log different dose…</button>
        </div>
      </div>

      <!-- Sparkline + log -->
      <div class="grid-2" style="margin-top:10px">
        <div class="card">
          <h4 style="margin:0 0 6px">Recent doses</h4>
          <div id="stab_log" class="codebox" style="min-height:60px" aria-live="polite"></div>
        </div>
        <div class="card">
          <h4 style="margin:0 0 6px">Trend</h4>
          <canvas id="stab_spark" height="80" style="width:100%"></canvas>
        </div>
      </div>

      <!-- Guidance -->
      <div class="card" style="margin-top:10px">
        <div class="muted">
          <b>Tip:</b> If you get withdrawal before the interval, increase interval gradually once steady; if you’re sleepy, reduce dose by 0.1–0.2&nbsp;ml.
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" onclick="STAB_saveBaseline()">Save as baseline for detox</button>
          <span id="stab_save_status" class="muted"></span>
        </div>
      </div>
    </div>
  </section>
    <!-- DETOX panel -->
  <section id="panel-detox" class="tabpanel" role="tabpanel" aria-labelledby="tab-detox" aria-hidden="true">
    <div class="card">
      <h2 style="margin-top:0">Detox plan</h2>
      <p class="muted">If stabilisation was needed, you should complete it before starting. If you skipped, you can still proceed but risk withdrawal.</p>
    </div>

    <!-- Starting point -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Starting point</h3>
      <div class="grid-3">
        <label>Starting dose (ml)<br>
          <input type="number" id="startDose" step="0.1" min="0" inputmode="decimal" data-autosave>
        </label>
        <label>Dose interval (h)<br>
          <input type="number" id="intervalHours" step="0.5" min="0.5" inputmode="decimal" data-autosave>
        </label>
        <label>Available supply (ml)<br>
          <input type="number" id="availableMl" step="0.1" min="0" inputmode="decimal" data-autosave>
        </label>
      </div>
    </div>

    <!-- Detox type -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Detox type</h3>
      <label><input type="radio" name="detoxType" value="stabilise_taper" checked> Stabilise → slow taper</label><br>
      <label><input type="radio" name="detoxType" value="short_taper"> Short taper</label><br>
      <label><input type="radio" name="detoxType" value="ultrarapid"> Ultrarapid (1 day)</label>
    </div>

    <!-- Reduction pattern -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Reduction cadence</h3>
      <label>Dose taken reduces:<br>
        <select id="decrementEvery" data-autosave>
          <option value="1h">Every 1 hour</option>
          <option value="2h">Every 2 hours</option>
          <option value="3h">Every 3 hours</option>
          <option value="6h">Every 6 hours</option>
          <option value="12h">Every 12 hours</option>
          <option value="24h" selected>Every 24 hours</option>
          <option value="48h">Every 48 hours</option>
        </select>
      </label>
      <label style="margin-top:8px">Amount reduced each step (ml)<br>
        <input type="number" id="decrementMl" step="0.1" min="0.1" value="0.1" inputmode="decimal" data-autosave>
      </label>
    </div>

    <!-- Preview -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Preview plan</h3>
      <div id="detox_preview" class="codebox" aria-live="polite">—</div>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" onclick="previewDetox()">Preview</button>
        <button class="btn ghost" onclick="createDetoxSchedule()">Create detox calendar</button>
      </div>
    </div>

    <!-- Calendar -->
    <div id="calendarWrap" class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Detox calendar</h3>
      <div id="calendar" class="cal"></div>
      <div id="detox_today" class="pill" style="margin-top:8px">Currently: —</div>
    </div>

    <!-- Dock for logging -->
    <div class="dock" id="detoxDock" style="margin-top:10px">
      <div class="row">
        <span class="muted" id="detox_clock">—</span>
        <span class="pill" id="detox_timerpill">Time since last dose: —</span>
        <span class="right"></span>
        <button id="doseBtn" class="btn btn-timer orange" onclick="logDose()">Log dose (— ml)</button>
        <button id="dosePickBtn" class="btn" onclick="openDosePicker('detox')">Log different dose…</button>
      </div>
    </div>

    <!-- Export -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 6px">Export options</h3>
      <div class="row">
        <button class="btn" onclick="exportICS()">Download .ics</button>
        <button class="btn" onclick="exportPDF()">Print / Save PDF</button>
        <button class="btn ghost" onclick="exportJSON()">Export JSON</button>
      </div>
    </div>
  </section>

  <!-- SYMPTOMS panel -->
  <section id="panel-symptoms" class="tabpanel" role="tabpanel" aria-labelledby="tab-symptoms" aria-hidden="true">
    <div class="card">
      <h2 style="margin-top:0">Symptoms & feedback</h2>
      <p class="muted">Log withdrawal symptoms and get inline feedback.</p>
    </div>
    <div class="card" style="margin-top:12px">
      <label>Current symptom score (0–10)<br>
        <input type="number" id="symptom_score" min="0" max="10" step="1" inputmode="numeric">
      </label>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="logSymptom()">Log symptom</button>
        <span id="symptom_note" class="muted"></span>
      </div>
      <div id="symptom_log" class="codebox" style="margin-top:8px;min-height:60px" aria-live="polite"></div>
    </div>
  </section>

  <!-- Print-only views (moved outside tabs for page 1 cover) -->
  <div id="printCover" class="card" style="display:none;margin:12px auto;max-width:1024px">
    <h2>G-Safe Detox — Plan Summary</h2>
    <div id="printSummary" class="mono" style="white-space:pre-wrap"></div>
    <div class="feedback" style="margin-top:8px">
      <b>Safety:</b> Don’t mix with alcohol/benzos. Keep ≥1h between doses. If confusion, paranoia, fits, or collapse → <b>112/999</b>.
    </div>
  </div>
  <div id="printCal" style="display:none;margin:12px auto;max-width:1024px"></div>
</main>
<script>
/* ========= Version & storage ========= */
const APP_VERSION = "v3.1.1-mobile";
/* Force all <button> to be type=button (iOS safety) */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('button').forEach(b=>{
    if(!b.getAttribute('type')) b.setAttribute('type','button');
  });
}, {once:true});
document.addEventListener('DOMContentLoaded', ()=>{
  hydrateStart();
  bindTabs();                    // wire tabs
  setTimeout(initDetoxTab, 0);   // iOS: defer to end of event loop
  renderStabLog();
  selectTab('start');
});

/* Touch shim: translate touchend ➜ click only if Pointer Events missing */
(function addTouchClickShim(){
  const needsShim = matchMedia('(pointer:coarse)').matches;
  if(!needsShim) return;
  const hasPointer = 'onpointerup' in window;
  if(hasPointer) return;

  function tapToClick(e){
    const t = e.target.closest('.tabbtn, button, .btn');
    if(!t) return;
    if(!t.__tapLock){
      t.__tapLock = true;
      t.click();
      setTimeout(()=>{ t.__tapLock = false; }, 300);
      e.preventDefault();
      e.stopPropagation();
    }
  }
  document.addEventListener('touchend', tapToClick, {passive:false});
})();
  
  
  
/* Autosave helpers (Start tab quick screen + general inputs use data-autosave) */
function loadAutos(){
  document.querySelectorAll('[data-autosave]').forEach(el=>{
    const key = 'gs_'+el.id;
    const v = localStorage.getItem(key);
    if(v!==null){
      if(el.type==='checkbox' || el.type==='radio'){ el.checked = v==='1'; }
      else el.value = v;
    }
    el.addEventListener('change', ()=>saveAuto(el));
    el.addEventListener('input',  ()=>saveAuto(el));
  });
}
function saveAuto(el){
  const key = 'gs_'+el.id;
  const v = (el.type==='checkbox'||el.type==='radio') ? (el.checked?'1':'0') : el.value;
  try{ localStorage.setItem(key, v); }catch{}
}


function bindTabs(){
  const isCoarse = window.matchMedia && matchMedia('(pointer:coarse)').matches;

  document.querySelectorAll('.tabbtn').forEach(btn=>{
    if(btn.dataset._wired) return;
    btn.dataset._wired = '1';

    const id = btn.id.replace('tab-','');

    // Mouse / desktop
    btn.addEventListener('click', ()=>selectTab(id));

    // Touch: pointerup is reliable on iOS; prevent ghost clicks
    btn.addEventListener('pointerup', (e)=>{
      if(isCoarse){
        e.preventDefault();
        selectTab(id);
      }
    });

    // Keyboard
    btn.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        selectTab(id);
      }
    });

    // ARIA (belt & braces)
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-controls', `panel-${id}`);
  });
}

/* ========= Tabs ========= */
function selectTab(name){
  // Buttons
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.setAttribute('aria-selected', btn.id===`tab-${name}` ? 'true' : 'false');
    btn.tabIndex = (btn.id===`tab-${name}`) ? 0 : -1;
  });

  // Panels
  let found = false;
  document.querySelectorAll('.tabpanel').forEach(p=>{
    const show = (p.id===`panel-${name}`);
    p.setAttribute('aria-hidden', show ? 'false' : 'true');
    if(show) found = true;
  });

  // Scroll to the active panel (iOS-friendly)
  const active = document.getElementById(`panel-${name}`);
  if(active){ active.scrollIntoView({behavior:'smooth', block:'start'}); }

  // Fallback
  if(!found && name!=='start') selectTab('start');
}


/* ========= Quick screen (Start tab) ========= */
function QC_eval(){
  const flags = [
    $('#qc_often').checked,
    $('#qc_night').checked,
    $('#qc_withdrawal').checked,
    $('#qc_freq').checked,
    $('#qc_severe').checked
  ];
  const score = flags.reduce((a,b)=>a+(b?1:0),0);
  let msg = `Flags: ${score}/5\n`;
  let rec = '';
  if($('#qc_severe').checked){ rec = '⚠️ Severe withdrawal history → seek medical advice.\n'; }
  if($('#qc_withdrawal').checked || $('#qc_freq').checked){ rec += 'Likely dependence. Consider Stabilise → Taper.\n'; }
  if(score===0){ rec = 'Low immediate flags from quick screen. Use Recognise → Detailed checklist next.'; }
  $('#qc_status').textContent = (score>=3) ? 'High risk' : (score>=1 ? 'Some risk' : 'Low');
  $('#qc_result').textContent = msg + rec;
  // Store a path hint for Detox init
  localStorage.setItem('gsafe_rec_path', (score>=2 ? 'stabilise' : 'detox'));
}

/* ========= Recognise (quick triage + detailed) ========= */
function QT_analyse(){
  const binge = $('#qt_binge').checked;
  const daynight = $('#qt_daynight').checked;
  const weeks = $('#qt_weeks').checked;
  const gapok = $('#qt_gap').checked;
  const severe = $('#qt_severe').checked;
  const mix = $('#qt_mix').checked;
  let out = [];
  if(severe) out.push('⚠️ Severe WD features → medical advice.');
  if(mix) out.push('⚠️ Mixing with alcohol/benzos increases overdose risk.');
  if(binge && !weeks) out.push('Recent 2–5 day binge → consider Ultrarapid only with support; otherwise Stabilise + short taper.');
  if(daynight || weeks) out.push('Day & night or multi-week use → Stabilise first, then slow taper.');
  if(gapok && !daynight && !weeks) out.push('Long gaps suggest lower dependence risk → short taper may be feasible.');
  $('#qt_result').textContent = out.join('\n') || 'No major flags in quick triage. Use detailed checklist next.';
  $('#qt_status').textContent = (severe||mix||daynight||weeks) ? 'Higher risk' : 'Lower risk';
  // Save coarse path
  localStorage.setItem('gsafe_rec_path', (daynight||weeks) ? 'stabilise' : 'detox');
}

function SA_analyse(){
  const ml = parseFloat($('#q_usual_ml').value||'0');
  const shortGap = parseFloat($('#q_gap_hours').value||'0');
  const span = parseFloat($('#q_span_hours').value||'0');
  const days = parseInt($('#q_days_cont').value||'0',10);
  const nightOnly = $('#q_night_only').value==='yes';
  const severe = $('#q_severe_wd').value==='yes';

  let lines = [];
  if(severe) lines.push('⚠️ Severe withdrawal history → seek medical advice.');
  if(days>=7 || shortGap<3) lines.push('Likely physiological dependence → Stabilise first, then slow taper.');
  else if(days>=2 || shortGap<6) lines.push('Some dependence signals → consider Stabilise or a cautious short taper.');
  else lines.push('Lower dependence signals → short taper might be reasonable.');
  if(nightOnly && span>=12) lines.push('Night-only with long daytime gaps noted.');
  if(ml>=3) lines.push('Higher per-dose volume — be conservative with decrements.');

  $('#sa_summary').textContent = lines.join('\n');
  // Action buttons
  const actions = $('#sa_actions'); actions.innerHTML='';
  const btnStab = mkBtn('Apply: Stabilise → Taper', ()=>{ localStorage.setItem('gsafe_rec_path','stabilise'); $('#sa_next').textContent='Applied. Move to Stabilise tab when ready.'; });
  const btnShort= mkBtn('Apply: Short taper', ()=>{ localStorage.setItem('gsafe_rec_path','detox'); $('#sa_next').textContent='Applied. Move to Detox tab when ready.'; });
  actions.appendChild(btnStab); actions.appendChild(btnShort);
  if(severe){ const warn = document.createElement('span'); warn.className='badge bad'; warn.textContent='Medical advice recommended'; actions.appendChild(warn); }
  $('#sa_next').textContent = 'These choices apply to the plan but do not switch tabs automatically.';
}

/* ========= Stabilise ========= */
function STAB_suggest(){
  const recent = parseFloat($('#stab_recent_ml').value||'0');
  const shortGap = parseFloat($('#stab_short_gap').value||'0');
  const longGap = parseFloat($('#stab_long_gap').value||'0');
  // Simple heuristics
  let dose = Math.max(0.5, Math.min(4, (recent>0?recent:2)));
  let interval = 2;
  if(shortGap>=2 && shortGap<3) interval = 2;
  else if(shortGap>=1 && shortGap<2) interval = 1.5;
  else if(shortGap<1) interval = 1;
  if(longGap>=3) dose = Math.max(0.5, dose-0.1);
  $('#stab_suggest_out').textContent = `Try ${dose.toFixed(1)} ml every ${interval} h. Adjust based on symptoms: aim for minimal withdrawal without sedation.`;
  $('#stab_dose').value = dose.toFixed(1);
  $('#stab_interval').value = String(interval);
  $('#stab_suggest_note').textContent = 'Applied to stabilisation fields.';
}

function STAB_logDose(amount){
  const ml = (typeof amount==='number') ? amount : parseFloat($('#stab_dose').value||'0');
  const t = new Date().toISOString();
  const log = loadDoseLog('stab'); log.push({t, ml});
  saveDoseLog('stab', log);
  renderStabLog();
}
function renderStabLog(){
  const log = loadDoseLog('stab');
  $('#stab_log').textContent = log.slice(-10).map(e=>`${new Date(e.t).toLocaleTimeString()} — ${e.ml.toFixed(1)} ml`).join('\n') || '—';
  drawSpark('#stab_spark', log);
}
function STAB_saveBaseline(){
  const ml = parseFloat($('#stab_dose').value||'0');
  const h = parseFloat($('#stab_interval').value||'2');
  $('#startDose').value = ml.toFixed(1);
  $('#intervalHours').value = String(h);
  $('#stab_baseline').value='yes';
  saveAuto($('#startDose')); saveAuto($('#intervalHours')); saveAuto($('#stab_baseline'));
  $('#stab_save_status').textContent = 'Saved as starting point for Detox.';
}

/* ========= Detox core ========= */
const ULTRARAPID_DISABLED = false;

function parseDecEveryToHours(code){
  if(!code) return 24;
  const m = String(code).match(/^(\d+)\s*h$/i);
  if(m) return Math.max(1, parseInt(m[1],10));
  if(code==='12h') return 12;
  if(code==='24h') return 24;
  if(code==='48h') return 48;
  return 24;
}
function autoSwitchUltrarapidIfNeeded(){
  const sel = $('#decrementEvery'); if(!sel) return;
  const h = parseDecEveryToHours(sel.value);
  const ultra = h < 12;
  const radio = document.querySelector('input[name="detoxType"][value="ultrarapid"]');
  if(ultra && radio && !radio.checked){
    if(!ULTRARAPID_DISABLED){
      radio.checked = true;
      explainDetoxType();
    }else{
      sel.value = '12h';
      alert('Ultrarapid detox is disabled in this build. Minimum reduction cadence is every 12 hours.');
    }
  }
}
function explainDetoxType(){
  // This can be expanded to show banners; kept minimal here
  return;
}

// Safe numeric parse: handles "0,1", trims, strips units
function parseNum(v, d=0){
  if(v==null) return d;
  const s = String(v).trim().replace(',', '.').replace(/[^0-9.\-]/g, '');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : d;
}

function previewDetox(){
  const elDose = $('#startDose');
  const elInt  = $('#intervalHours');
  const elDec  = $('#decrementMl');
  const elEvery= $('#decrementEvery');
  const out    = $('#detox_preview');

  if(!elDose || !elInt || !elDec || !elEvery || !out){ return; }

  let dose       = parseNum(elDose.value, 0);
  let intervalH  = parseNum(elInt.value, 0);
  let decMl      = parseNum(elDec.value, 0.1);
  const decHours = parseDecEveryToHours(elEvery.value);
  const type     = document.querySelector('input[name="detoxType"]:checked')?.value || 'short_taper';

  // Guards & normalisation
  if(dose <= 0 || intervalH <= 0){ out.textContent='Enter starting dose & interval.'; return; }
  decMl = Math.max(0.05, Math.min(dose, decMl)); // at least 0.05 ml, not more than the start dose

  // Normalise the field visually after edits (nice on iPhone)
  elDec.value = decMl.toFixed(1);

  const steps = buildPlanSteps(dose, intervalH, decMl, decHours);
  window._plan = { steps };

  if(!steps.length){ out.textContent='Decrement produced an empty plan. Increase starting dose or decrease step size.'; return; }

  const last = steps[steps.length-1];
  const lenDays = Math.max(1, Math.round((new Date(last.end) - new Date(steps[0].start))/86400000)+1);
  const vols = calcVolumes(steps, intervalH);
  const isUltra = decHours < 12;

  let lines = [];
  lines.push(`Type: ${type}${isUltra?' (ultrarapid cadence)':''}`);
  lines.push(`Start: ${new Date(steps[0].start).toLocaleString()}`);
  lines.push(`Plan length: ~${lenDays} days`);
  lines.push(`Decrement: –${decMl.toFixed(1)} ml every ${decHours} h`);
  lines.push(`Estimate if dosing hourly: ${vols.totalMax.toFixed(1)} ml`);
  lines.push(`Estimate at plan interval: ${vols.totalPred.toFixed(1)} ml`);
  out.textContent = lines.join('\n');

  updateTodayBadge(steps, intervalH);
}

function buildPlanSteps(dose, intervalH, decMl, decHours){
  const start = new Date();
  const steps = [];
  let curDose = dose;
  let t = new Date(start);
  const oneH = 60*60*1000;

  // Safety: if decMl is zero or negative, bail to avoid infinite loop
  if(!(decMl > 0)) return steps;

  while(curDose > 0){
    const end = new Date(t.getTime() + decHours*oneH);
    steps.push({ start: new Date(t), end, ml: +curDose.toFixed(1) });

    // Float-safe decrement to 1 decimal place
    const next = Math.round((curDose - decMl) * 10) / 10;
    curDose = Math.max(0, next);

    t = end;
    if(steps.length > 2000) break;
  }
  return steps;
}
function calcVolumes(steps, intervalH){
  // Max: assume hourly dosing within each step window
  let totalMax = 0, totalPred = 0;
  const oneH = 60*60*1000;
  steps.forEach(s=>{
    const hours = (new Date(s.end)-new Date(s.start))/oneH;
    const dosesMax = Math.ceil(hours / 1);            // hourly
    const dosesPred = Math.ceil(hours / intervalH);    // plan interval
    totalMax += dosesMax * s.ml;
    totalPred += dosesPred * s.ml;
  });
  return { totalMax, totalPred };
}

function updateTodayBadge(steps, intervalH){
  const now = new Date();
  const today = steps.find(s=> now>=new Date(s.start) && now<new Date(s.end));
  const el = $('#detox_today');
if(!el) return;
  if(today){
    el.textContent = `Currently: ${today.ml.toFixed(1)} ml every ${intervalH} h`;
  }else{
    el.textContent = 'Currently: —';
  }
}

/* ========= Calendar builder (interactive + print content) ========= */
const CAL_INITIAL_HOUR_PX = 28;

function createDetoxSchedule(){
  if(!window._plan?.steps?.length) { return; }
  if(!window._plan || !window._plan.steps){ previewDetox(); }

  const steps = (window._plan?.steps)||[];
  const intervalH = parseFloat($('#intervalHours').value||'0');
  const cal = $('#calendar'); cal.innerHTML='';
  const HOUR_PX = (window.__CAL_HPX || CAL_INITIAL_HOUR_PX);
  document.documentElement.style.setProperty('--hourpx', HOUR_PX + 'px');

  // Map periods per day
  const byDay = {};
  for(let i=0;i<steps.length-1;i++){
    const s=steps[i]; const startS=new Date(s.start), endS=new Date(s.end);
    let d = new Date(startS); d.setHours(0,0,0,0);
    while(d < endS){
      const dayStart = new Date(d);
      const nextDay = new Date(dayStart); nextDay.setDate(dayStart.getDate()+1);
      const segStart = new Date(Math.max(dayStart, startS));
      const segEnd   = new Date(Math.min(nextDay,  endS));
      const key = dayStart.toDateString();
      (byDay[key] ||= []).push({from: segStart, to: segEnd, ml: s.ml});
      d = nextDay;
    }
  }

  const days = Object.keys(byDay).map(k=>new Date(k)).sort((a,b)=>a-b);
  const yPx = (base, dt)=> ((dt - base)/60000) * (HOUR_PX/60);

  days.forEach(day=>{
    const cell = document.createElement('div');
    cell.className='day';
    cell.innerHTML = `<h4>${day.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</h4>`;
    const grid = document.createElement('div'); grid.className='dayGrid';

    // left timecol
    const timeCol = document.createElement('div'); timeCol.className='timecol';
    for(let h=0; h<24; h++){
      const tick = document.createElement('div'); tick.className='tick';
      tick.textContent = (h%2===0) ? (String(h).padStart(2,'0')+':00') : '';
      timeCol.appendChild(tick);
    }

    // body
    const body = document.createElement('div'); body.className='daybody';
    body.style.height = (24*HOUR_PX)+'px';

    // now line (only for today)
    const now = new Date();
    if(now.toDateString()===day.toDateString()){
      const base = new Date(day); base.setHours(0,0,0,0);
      const top = Math.max(0, Math.min(24*HOUR_PX, Math.floor(yPx(base, now))));
      const nl = document.createElement('div'); nl.className='nowline'; nl.style.top = top+'px';
      body.appendChild(nl);
    }

    const startOfDay = new Date(day); startOfDay.setHours(0,0,0,0);
    (byDay[day.toDateString()]||[]).forEach(p=>{
      const top = Math.max(0, Math.floor(yPx(startOfDay, p.from)));
      const bottom = Math.min(24*HOUR_PX, Math.ceil(yPx(startOfDay, p.to)));
      const height = Math.max(4, bottom-top);
      const seg = document.createElement('div'); seg.className='segBlock';
      seg.style.top = top+'px';
      seg.style.height = height+'px';
      seg.textContent = `${p.ml.toFixed(1)} ml every ${intervalH} h`;
      body.appendChild(seg);
    });

    // Logged doses
    const logs = loadDoseLog('detox').filter(e => new Date(e.t).toDateString()===day.toDateString());
    logs.forEach(e=>{
      const t=new Date(e.t);
      const mark=document.createElement('div');
      mark.className='doseMark green';
      mark.style.top = Math.max(0, Math.min(24*HOUR_PX, Math.floor(yPx(startOfDay, t)))) + 'px';
      body.appendChild(mark);
    });

    grid.appendChild(timeCol); grid.appendChild(body);
    cell.appendChild(grid);
    cal.appendChild(cell);
  });

  updateTodayBadge(steps, intervalH);
  updateDetoxTimer();

  // Build print cover + weekly pages
  buildPrintViews(steps, intervalH);
}

function startOfWeek(d){
  const a = new Date(d); const day = (a.getDay()+6)%7; a.setHours(0,0,0,0); a.setDate(a.getDate()-day); return a;
}
function weekKey(d){
  const s = startOfWeek(d);
  return `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}`;
}
function buildPrintViews(steps, intervalH){
  const printCal = $('#printCal'); const printSummary = $('#printSummary');
  if(!printCal || !printSummary) return;
  printCal.innerHTML='';

  // Summary
  if(steps?.length){
    const first = steps[0].start;
    const last  = steps[steps.length-1].end;
    const dose = parseFloat($('#startDose').value||'0');
    const decMl = parseFloat($('#decrementMl').value||'0.1');
    const decHours = parseDecEveryToHours($('#decrementEvery').value);
    const { totalMax, totalPred } = calcVolumes(steps, intervalH);
    const lenDays = Math.max(1, Math.round((new Date(last)-new Date(first))/86400000)+1);
    printSummary.textContent =
`Start: ${new Date(first).toLocaleString()}
Starting dose: ${dose.toFixed(1)} ml every ${intervalH} h
Reduction: –${decMl.toFixed(1)} ml every ${decHours} h
Plan length: ~${lenDays} days
Supply estimate (hourly): ${totalMax.toFixed(1)} ml
Supply estimate (plan interval): ${totalPred.toFixed(1)} ml`;
  }

  // Group days per week
  const byDay = {};
  const oneDay = 24*60*60*1000;
  for(let i=0;i<steps.length-1;i++){
    const s=steps[i]; const startS=new Date(s.start), endS=new Date(s.end);
    let d = new Date(startS); d.setHours(0,0,0,0);
    while(d < endS){
      const dayStart = new Date(d);
      const nextDay = new Date(dayStart.getTime()+oneDay);
      const segStart = new Date(Math.max(dayStart, startS));
      const segEnd   = new Date(Math.min(nextDay,  endS));
      const key = dayStart.toDateString();
      (byDay[key] ||= []).push({from: segStart, to: segEnd, ml: s.ml});
      d = nextDay;
    }
  }
  const days = Object.keys(byDay).map(k=>new Date(k)).sort((a,b)=>a-b);
  const weeks = {};
  days.forEach(d=>{ (weeks[weekKey(d)] ||= []).push(new Date(d)); });

  const HOUR_PX = (window.__CAL_HPX || CAL_INITIAL_HOUR_PX);

  // Render each week
  Object.entries(weeks).forEach(([wk, list])=>{
    // Ensure 7 days
    const start = startOfWeek(list[0]);
    const full7 = Array.from({length:7}, (_,i)=>{ const dd=new Date(start); dd.setDate(start.getDate()+i); return dd; });

    const page = document.createElement('section');
    page.className='weekPrint';
    const endW = new Date(start); endW.setDate(start.getDate()+6);
    const title = document.createElement('h2');
    title.textContent = `Week of ${start.toLocaleDateString()} – ${endW.toLocaleDateString()}`;
    page.appendChild(title);

    const row = document.createElement('div');
    row.style.display='grid'; row.style.gridTemplateColumns='repeat(7,1fr)'; row.style.gap='8px';

    const yPx = (base, dt)=> ((dt - base)/60000) * (HOUR_PX/60);

    full7.forEach(day=>{
      const cell = document.createElement('div'); cell.className='day';
      cell.innerHTML = `<h4>${day.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</h4>`;
      const grid = document.createElement('div'); grid.className='dayGrid';

      const timeCol = document.createElement('div'); timeCol.className='timecol';
      for(let h=0; h<24; h++){
        const tick = document.createElement('div'); tick.className='tick';
        tick.textContent = (h%2===0) ? (String(h).padStart(2,'0')+':00') : '';
        timeCol.appendChild(tick);
      }

      const body = document.createElement('div'); body.className='daybody';
      body.style.height = (24*HOUR_PX)+'px';
      const startOfDay = new Date(day); startOfDay.setHours(0,0,0,0);

      (byDay[day.toDateString()]||[]).forEach(p=>{
        const top = Math.max(0, Math.floor(yPx(startOfDay, p.from)));
        const bottom = Math.min(24*HOUR_PX, Math.ceil(yPx(startOfDay, p.to)));
        const height = Math.max(4, bottom-top);
        const seg = document.createElement('div'); seg.className='segBlock';
        seg.style.top = top+'px'; seg.style.height = height+'px';
        seg.textContent = `${p.ml.toFixed(1)} ml every ${intervalH} h`;
        body.appendChild(seg);
      });

      // Dose marks
      const logs = loadDoseLog('detox').filter(e => new Date(e.t).toDateString()===day.toDateString());
      logs.forEach(e=>{
        const t=new Date(e.t);
        const mark=document.createElement('div');
        mark.className='doseMark green';
        mark.style.top = Math.max(0, Math.min(24*HOUR_PX, Math.floor(yPx(startOfDay, t)))) + 'px';
        body.appendChild(mark);
      });

      grid.appendChild(timeCol); grid.appendChild(body);
      cell.appendChild(grid);
      row.appendChild(cell);
    });

    page.appendChild(row);
    printCal.appendChild(page);
  });
}

/* ========= Dose logging & picker ========= */
function $(id){ return document.getElementById(id); }

function loadDoseLog(kind='detox'){
  try{ return JSON.parse(localStorage.getItem('gs_dose_log_'+kind)||'[]'); }catch{return []}
}
function saveDoseLog(kind='detox', log){
  try{ localStorage.setItem('gs_dose_log_'+kind, JSON.stringify(log)); }catch{}
}

function logDose(amount){
  const planSteps = window._plan?.steps || [];
  const intervalH = parseFloat($('#intervalHours').value||'0');
  const t = new Date().toISOString();
  // default to current plan dose
  let ml = (typeof amount==='number') ? amount : 0;
  if(!amount && planSteps.length){
    const now = new Date();
    const cur = planSteps.find(s=> now>=new Date(s.start) && now<new Date(s.end));
    if(cur) ml = cur.ml;
  }
  if(ml<=0){ alert('No current dose found. Enter a starting dose & preview the plan first.'); return; }
  const log = loadDoseLog('detox'); log.push({t, ml});
  saveDoseLog('detox', log);
  updateDetoxTimer();
  createDetoxSchedule(); // refresh marks
}

/* Simple in-page dose picker */
function openDosePicker(mode){
  const planSteps = window._plan?.steps || [];
  let rec = 0;
  if(mode==='detox' && planSteps.length){
    const now = new Date();
    const cur = planSteps.find(s=> now>=new Date(s.start) && now<new Date(s.end));
    if(cur) rec = cur.ml;
  }else if(mode==='stabilise'){
    rec = parseFloat($('#stab_dose').value||'0');
  }
  const choices = [];
  for(let d = Math.max(0.1, rec-0.4); d <= rec+0.4+1e-9; d+=0.1){ choices.push(+d.toFixed(1)); }
  const sel = prompt(`Select dose to log (${rec?`recommended ${rec.toFixed(1)} ml`:''})\n` + choices.map(v=>{
    if(rec && Math.abs(v-rec)<0.05) return `[✓] ${v.toFixed(1)} ml (recommended)`;
    if(rec && Math.abs(v-rec)<=0.1+1e-9) return `• ${v.toFixed(1)} ml (±0.1)`;
    if(rec && Math.abs(v-rec)<=0.2+1e-9) return `! ${v.toFixed(1)} ml (±0.2)`;
    return `× ${v.toFixed(1)} ml`;
  }).join('\n'));
  const val = parseFloat(sel||'NaN');
  if(!isNaN(val)){
    if(mode==='detox') logDose(val); else STAB_logDose(val);
  }
}

/* ========= Timers (1s tick, foreground only) ========= */
function isDetoxVisible(){ return $('#panel-detox')?.getAttribute('aria-hidden')==='false'; }
function isStabVisible(){ return $('#panel-stabilise')?.getAttribute('aria-hidden')==='false'; }

function updateDetoxTimer(){
  const log = loadDoseLog('detox');
  const pill = $('#detox_timerpill');
  const btn = $('#doseBtn');
  const now = Date.now();
  let last = null;
  if(log.length){ last = new Date(log[log.length-1].t).getTime(); }
  const ms = last ? (now-last) : 0;
  const sec = Math.floor(ms/1000)%60;
  const min = Math.floor(ms/60000)%60;
  const hr  = Math.floor(ms/3600000);
  pill.textContent = `Time since last dose: ${hr}h ${String(min).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;

  // Button color: red (<1h), orange (<interval), green (>= interval)
  const intervalH = parseFloat($('#intervalHours').value||'0') || 2;
  const intervalMs = intervalH*3600000;
  btn.classList.remove('red','orange','green');
  if(!last){ btn.classList.add('orange'); btn.textContent='Log dose (— ml)'; return; }
  const planSteps = window._plan?.steps || [];
  let rec = 0;
  if(planSteps.length){
    const n = new Date();
    const cur = planSteps.find(s=> n>=new Date(s.start) && n<new Date(s.end));
    rec = cur ? cur.ml : 0;
  }
  btn.textContent = `Log dose (${rec?rec.toFixed(1):'—'} ml)`;
  if(ms < 3600000) btn.classList.add('red');
  else if(ms < intervalMs) btn.classList.add('orange');
  else btn.classList.add('green');
  $('#detox_clock').textContent = new Date().toLocaleString();
}

function updateStabTimer(){
  const log = loadDoseLog('stab');
  const pill = $('#stab_timerpill');
  const now = Date.now();
  let last = null;
  if(log.length){ last = new Date(log[log.length-1].t).getTime(); }
  const ms = last ? (now-last) : 0;
  const sec = Math.floor(ms/1000)%60;
  const min = Math.floor(ms/60000)%60;
  const hr  = Math.floor(ms/3600000);
  pill.textContent = `Time since last dose: ${hr}h ${String(min).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
  $('#stab_clock').textContent = new Date().toLocaleString();
}

/* Single ticking interval that respects visibility */
function tickTimers(){
  if (document.visibilityState==='visible'){
    if(isDetoxVisible()){ updateDetoxTimer(); }
    if(isStabVisible()){ updateStabTimer(); renderStabLog(); }
  }
}
clearInterval(window.__GS_TICK);
window.__GS_TICK = setInterval(tickTimers, 1000);

/* ========= Exporters ========= */
function exportJSON(){
  const data = {
    startDose: $('#startDose')?.value ?? '',
    intervalHours: $('#intervalHours')?.value ?? '',
    decrementMl: $('#decrementMl')?.value ?? '',
    decrementEvery: $('#decrementEvery')?.value ?? '',
    steps: window._plan?.steps || [],
    doseLog: { detox: loadDoseLog('detox'), stabilise: loadDoseLog('stab') }
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'gsafe_detox_plan.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 0);
}

function exportICS(){
  if(!window._plan?.steps?.length){ previewDetox(); if(!window._plan?.steps?.length){ alert('Create a plan first.'); return; } }
  const steps = window._plan.steps;
  const intervalH = parseFloat($('#intervalHours').value||'0');
  const lines = [
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//GSafe//Detox//EN'
  ];
  steps.forEach(s=>{
    const dt = new Date(s.start);
    // Create a reminder at the start of each segment for dosing cadence; user can add more
    const uid = Math.random().toString(36).slice(2)+'@gsafe';
    const dtStart = toICS(dt);
    const dtEnd = toICS(new Date(s.end));
    lines.push('BEGIN:VEVENT');
    lines.push('UID:'+uid);
    lines.push('DTSTAMP:'+toICS(new Date()));
    lines.push('DTSTART:'+dtStart);
    lines.push('DTEND:'+dtEnd);
    lines.push('SUMMARY:'+`Detox: ${s.ml.toFixed(1)} ml every ${intervalH} h`);
    lines.push('DESCRIPTION:'+`Dose window for ${s.ml.toFixed(1)} ml`);
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob = new Blob([lines.join('\r\n')], {type:'text/calendar'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download='detox_plan.ics'; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),0);
}
function toICS(d){
  const pad=n=>String(n).padStart(2,'0');
  return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+'T'+pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+'Z';
}

/* Mobile-friendly Print: open a minimal print window (works on iOS/Android) */
function exportPDF(){
  if(!window._plan?.steps?.length){ previewDetox(); if(!window._plan?.steps?.length){ alert('Create a plan first.'); return; } }
  createDetoxSchedule(); // ensure print views are built

  const cover = $('#printCover'); const cal = $('#printCal');
  const html =
`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>G-Safe Detox — Print</title>
<style>
  @page { size:A4 landscape; margin:10mm; }
  @media print { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  :root{ --hourpx:24px; }
  body{margin:0 auto; max-width:1024px; font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
  h2{margin:0 0 8px}
  .day{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff}
  .day h4{margin:0 0 6px;font-size:12px;color:#444}
  .dayGrid{display:grid;grid-template-columns:48px 1fr;gap:8px}
  .timecol{font-size:10px;color:#666}
  .timecol .tick{height:var(--hourpx);line-height:var(--hourpx);border-top:1px dashed #ccc}
  .daybody{position:relative;border:1px solid #ccc;border-radius:6px;
    background:repeating-linear-gradient(to bottom,rgba(0,0,0,.03)0 calc(var(--hourpx)-1px),rgba(0,0,0,.08) calc(var(--hourpx)-1px) var(--hourpx))}
  .segBlock{position:absolute;left:6px;right:6px;border-radius:6px;background:rgba(96,165,250,.18);border:1px solid #60a5fa;font-size:10px;padding:3px 5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .doseMark{position:absolute;left:0;right:0;height:2px;background:#22c55e;opacity:.95}
  .weekPrint{page-break-after:always; break-after:page}
</style></head><body>`+
  cover.outerHTML + cal.outerHTML +
`<script>window.onload=function(){setTimeout(function(){window.print()},50);setTimeout(function(){window.close()},500)}<\/script></body></html>`;

  const w = window.open('', '_blank');
  if(!w){ // fallback
    $('#printCover').style.display='block';
    $('#printCal').style.display='block';
    const hide=()=>{ $('#printCover').style.display='none'; $('#printCal').style.display='none'; };
    const onAfter=()=>{ hide(); window.removeEventListener('afterprint',onAfter); };
    window.addEventListener('afterprint', onAfter);
    setTimeout(hide, 0);
    return window.print();
  }
  w.document.open(); w.document.write(html); w.document.close();
}

/* ========= Canvas & charts ========= */
function drawSpark(sel, log){
  const c = document.querySelector(sel); if(!c) return;
  const ctx = c.getContext('2d');
  const W = c.width = c.clientWidth || 300, H = c.height;
  ctx.clearRect(0,0,W,H);
  if(!log.length) return;
  const pts = log.slice(-30).map(e=>({x:new Date(e.t).getTime(), y:e.ml}));
  const minx = pts[0].x, maxx = pts[pts.length-1].x;
  const miny = Math.min(...pts.map(p=>p.y)), maxy = Math.max(...pts.map(p=>p.y));
  ctx.beginPath();
  pts.forEach((p,i)=>{
    const x = ( (p.x-minx) / Math.max(1,(maxx-minx)) ) * (W-10) + 5;
    const y = H - ((p.y-miny)/Math.max(0.1,(maxy-miny)))*(H-10) - 5;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 2; ctx.stroke();
}

/* ========= Utilities ========= */
function $(id){ return document.getElementById(id); }

/* ========= Init ========= */
function initDetoxTab(){
  ['availableMl','startDose','intervalHours','decrementMl','decrementEvery'].forEach(id=>{
    const el = $('#'+id); if(!el) return;
    if(el.dataset._wired) return; el.dataset._wired='1';

    el.addEventListener('input',  previewDetox);
    el.addEventListener('change', previewDetox);

    if(id === 'decrementMl'){
      el.addEventListener('blur', ()=>{
        const v = Math.max(0.05, Math.min(parseNum(el.value, 0.1), 10));
        el.value = v.toFixed(1);
        previewDetox();
        saveAuto(el);
      });
    }
    if(id==='decrementEvery'){
      el.addEventListener('input',  autoSwitchUltrarapidIfNeeded);
      el.addEventListener('change', autoSwitchUltrarapidIfNeeded);
    }
  });
  autoSwitchUltrarapidIfNeeded();
  if ($('#startDose') && $('#intervalHours') && $('#decrementMl') && $('#decrementEvery')) {
    previewDetox();
  }
}

function hydrateStart(){
  loadAutos();

  /* ⭐ Default decrement to 0.1 ml on first-ever load */
  const dec = $('#decrementMl');
  if (dec && localStorage.getItem('gs_decrementMl') === null) {
    dec.value = '0.1';
    saveAuto(dec);
  }

  // default recommended path
  if(!localStorage.getItem('gsafe_rec_path')) localStorage.setItem('gsafe_rec_path','detox');
  // show version
  const v = $('#appVersion'); if(v) v.textContent = APP_VERSION;
}

function clearAllSavedData(){
  // Double-confirm (mobile friendly)
  if(!confirm('This will erase all G-Safe data on this device (plans, logs, saved answers). Continue?')) return;
  if(!confirm('Are you absolutely sure? This cannot be undone.')) return;

  // Remove our keys from localStorage
  try{
    const toRemove = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && (k.startsWith('gs_') || k.startsWith('gsafe_'))) toRemove.push(k);
    }
    toRemove.forEach(k=>localStorage.removeItem(k));
  }catch(e){ /* ignore quota/permission issues */ }

  // In-memory reset
  window._plan = { steps: [] };

  // Clear dose logs explicitly (also ensures UI resets)
  saveDoseLog('detox', []);
  saveDoseLog('stab',  []);

  // Reset form fields (safe even if some are missing)
  [
    'availableMl','startDose','intervalHours','decrementMl','decrementEvery',
    'stab_recent_ml','stab_short_gap','stab_long_gap','stab_dose','stab_interval','stab_baseline',
    'q_usual_ml','q_gap_hours','q_span_hours','q_days_cont','q_night_only','q_severe_wd',
    'qc_often','qc_night','qc_withdrawal','qc_freq','qc_severe',
    'qt_daynight','qt_binge','qt_weeks','qt_gap','qt_mix','qt_severe',
    'symptom_score'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(el.type==='checkbox' || el.type==='radio'){ el.checked = false; }
    else if(el.tagName==='SELECT'){ el.selectedIndex = 0; }
    else el.value = '';
  });

  // Clear text outputs & calendar
  ['qc_status','qc_result','qt_status','qt_result','sa_summary','sa_next',
   'stab_suggest_out','stab_save_status','stab_log','detox_today','detox_preview',
   'symptom_log','symptom_note','printSummary'
  ].forEach(id=>{ const n=$(id); if(n) n.textContent='—'; });
  const cal = $('#calendar');     if(cal) cal.innerHTML='';
  const printCal = $('#printCal'); if(printCal) printCal.innerHTML='';

  // Rehydrate defaults (includes setting decrement to 0.1 on first load)
  hydrateStart();
  initDetoxTab();
  renderStabLog();
  previewDetox();
  updateDetoxTimer();
  updateStabTimer();

  const status = $('#clear_status');
  if(status){ status.textContent = 'All local data cleared.'; setTimeout(()=>status.textContent='', 4000); }

  alert('All local G-Safe data has been cleared on this browser.');
  selectTab('start');
}

/* Helper to create buttons quickly */
function mkBtn(label, onclick){
  const b = document.createElement('button'); b.className='btn'; b.textContent=label; b.onclick=onclick; return b;
}

/* Minimal error toast for mobile debugging */
(function(){
  const toast = document.createElement('div');
  toast.style.cssText = 'position:fixed;left:8px;right:8px;bottom:8px;z-index:9999;background:#3b0a0a;color:#fecaca;border:1px solid #7f1d1d;border-radius:10px;padding:8px;display:none;white-space:pre-wrap';
  document.body.appendChild(toast);
  window.addEventListener('error', (e)=>{
    toast.textContent = 'Error: ' + (e.message || 'unknown');
    toast.style.display = 'block';
  });
})();
  
  
</script>
</body>
</html>  
  
